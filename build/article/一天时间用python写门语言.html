<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>网络寻租</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="halida" />
    <link rel="alternate" type="application/rss+xml" title="网络寻租 - RSS" href="http://blog.linjunhalida.com/feed" />
    <link href="/stylesheets/pygments-default.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/site.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/jquery.js" type="text/javascript"></script>
  </head>
  <body class='color-4'>
    <div id='warper'>
      <nav>
        <div id='container'>
          <ul class='first-nav'>
            <li>
              <a href="/">网络寻租</a>
            </li>
            <li>
              <a href="/list.html">列表</a>
            </li>
            <li>
              <a href="/about.html">关于</a>
            </li>
          </ul>
          <ul class='secondary-nav'>
            <li>
              <a href="/feed.xml">feed</a>
            </li>
          </ul>
          <select id='color-select'>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </div>
      </nav>
      <div id='block-nav'></div>
      <div id='content'>
        <div class='article'>
          <g:plusone></g:plusone>
          <script type='text/javascript'>
            //<![CDATA[
              window.___gcfg = {lang: 'zh-CN'};
              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
            //]]>
          </script>
          <h1 class='article-title'>一天时间用python写门语言</h1>
          <div class="document">
          <img alt="http://www.hrsolutionsinc.com/engagementcalculator/calculator.jpg" class="align-center" src="http://www.hrsolutionsinc.com/engagementcalculator/calculator.jpg" />
          <p>今天我在广州加班, 上午其他同事去干活我一个人在旅店, 没事做就又练习写计算器程序了.
          本来打算用python来写一个简单的支持加减乘除括号的计算器,
          后来有加上了变量复制, 比较符, 条件判断, 循环, 最后还加上了函数,
          几乎可以说是一个简单的语言了. 以后我也可以说写过一门语言了哈哈.</p>
          <p>回到正题. 这里面整理一下这个简单的程序用到的方法, 代码在: <a class="reference external" href="https://bitbucket.org/linjunhalida/code-example/src/tip/python/calculator/">https://bitbucket.org/linjunhalida/code-example/src/tip/python/calculator/</a></p>
          <p>一开始, 我希望实现一个简单的支持加减乘除括号的计算器, 我不打算用python自带的方式(eval), 而是自己写一个.
          虽然有种种取巧的方式, 我还是采用教科书般的方法, 首先词法分析, 然后语法分析+计算结果.</p>
          <div class="section" id="id1">
          <h1>词法分析</h1>
          <p>词法分析的函数是syntax_analysis, 输入一个字符串, 拆分成一个个的词, 解析整型和浮点.
          比如: &quot;2 * 3 + 1&quot; 就拆分成 [2, '*', 3, '+', 1], 没什么好说的, 从头开始解析即可.
          没有用到状态机, 只是简单的根据字符串的首字母做条件判断, 然后一个个往下读, 根据状况拆分.</p>
          </div>
          <div class="section" id="id2">
          <h1>语法分析</h1>
          <p>我采用的方法是从the C++ programming language里面那个计算机程序学来的方法: 首先写出基本的语法,
          然后每个语法模块写一个函数, 然后通过函数的递归调用来模拟语法树的生成和解析, 不需要显式地生成语法树.</p>
          <p>我用了一个类Caculator来保存词法分析后的list, 以及当前处理到的符号位置, 变量表等东西, 语法模块都是这个类的方法, 这样写起来方便一点.</p>
          <p>我们一部分一部分来吧. 首先我先实现加减乘除括号. 整理基本的语法:</p>
          <pre class="literal-block">
          l0 = (ltop) | n | - n
          l1 = l1 * l0 | l1 / l0 | l0
          l2 = l2 + l1 | l2 - l1 | l1
          ltop = l2
          </pre>
          <p>n 是数字. 里面l0, l1, l2, 是根据优先级做了分割, 保证优先级高的操作首先执行. ltop的目的是为了方便扩充新的运算符号.</p>
          <p>l2函数如下, 整体的逻辑是, 当发现下一个符号是'+-'的时候, 就一直解析和计算v, 然后返回v.
          self.ls是词法分析后的词列表, self.p是表示当前处理到的词位置.
          inc()表示解析下一个词, get()获取下一个词, has_next()判断下面还有没有.</p>
          <p>所有的函数都类似这样的方式, 不传参数进去, 解析词列表, 返回计算后的结果.</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">l2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">()</span>
              <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">()</span>
                     <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                     <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">in</span> <span class="s">&#39;+-&#39;</span><span class="p">):</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                      <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">()</span>
                      <span class="n">v</span> <span class="o">+=</span> <span class="n">v2</span>
                  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                      <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">()</span>
                      <span class="n">v</span> <span class="o">-=</span> <span class="n">v2</span>
              <span class="k">return</span> <span class="n">v</span>
          </pre></div>
          </div>
          <div class="section" id="id3">
          <h1>赋值</h1>
          <p>然后我开始实现赋值功能, 同时考虑扩展成为能够解析多个表达式的语法, 这个基本也是抄the C++ programming language的方法,
          改了几点:</p>
          <ul class="simple">
          <li>加了program, exp_list, exp, 更像一个语言了.</li>
          <li>l0加上NAME, 能够获取NAME对应变量的值.</li>
          <li>assignment赋值的操作. 为了通用, 赋值也是有返回值的.</li>
          </ul>
          <pre class="literal-block">
          l0 = (ltop) | n | NAME
          
          program = END | exp_list END
          exp_list = exp_list ; exp
          exp = ltop | assignment
          
          assignment = NAME = exp
          </pre>
          <p>赋值和计算都是exp的一种, 代码是这样写的:</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
                      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="p">()</span>
                  <span class="o">...</span>
          
              <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span><span class="p">()</span>
          </pre></div>
          <p>我在Caculator类里面加了一个values的dict, 用来保存赋值的值, 赋值和获取值的代码:</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
              <span class="k">return</span> <span class="n">v</span>
          
          <span class="k">def</span> <span class="nf">l0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
              <span class="o">...</span>
              <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">issymbol</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
          </pre></div>
          </div>
          <div class="section" id="id4">
          <h1>条件判断</h1>
          <p>现在我的简单语法变得有点像一门真正的语言了, 但是还缺少很多必要的东西, 我思考如何实现条件判断. 首先实现判断语句, 语法:</p>
          <pre class="literal-block">
          l3 = l2 &lt; l2 | l2 &gt; l2 | l2 == l2 | l2
          ltop = l3
          </pre>
          <p>实现很简单, 判断下一个符号是什么而已, 为了简单, 我没有加上True/False, 而是统一用1/0的方式来做, 真返回1, 假返回0.</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">l3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                  <span class="k">return</span> <span class="n">v</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">v2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
                  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
              <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">v2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
                  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
              <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;==&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
                  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
          
              <span class="k">return</span> <span class="n">v</span>
          </pre></div>
          <p>然后实现条件判断. 语法如下:</p>
          <pre class="literal-block">
          exp = ltop | assignment | condition
          condition = if ltop {exp_list} else {exp_list}
          </pre>
          <p>exp里面判断第一个词是不是if, 然后跳转到condition函数(循环, 函数也采用类似的方法来判断), 然后解析条件判断的值, 如果大于一, 解析第一个exp_list, 不然解析第2个exp_list. 里面做了一些语法错误的判断. 还有else部分是可选的, 为了简单没有实现elif的方式.
          对于不需要解析的exp_list, 我利用goto_next_block来跳转, 要注意的是处理嵌套{}的问题.</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
                      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="p">()</span>
                  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;if&#39;</span><span class="p">:</span>
                      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">()</span>
                  <span class="o">...</span>
          
          <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span><span class="p">()</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : no {&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">()</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">goto_next_block</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : not }&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;else&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : no {&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">()</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">goto_next_block</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : not }&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="k">return</span> <span class="n">v</span>
          
          <span class="k">def</span> <span class="nf">goto_next_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
              <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                      <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                      <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          </pre></div>
          </div>
          <div class="section" id="id5">
          <h1>循环</h1>
          <p>好了, 条件判断实现了, 下面该是循环了. 语法:</p>
          <pre class="literal-block">
          exp = ltop | assignment | condition | loop
          loop = while ltop {exp_list}
          </pre>
          <p>具体实现上, 我缓存了loop开始的位置, 先判断ltop,
          如果发现满足, 执行exp_list, 然后设置self.p为loop开始, 然后继续判断ltop. 不满足的话就跳出来.. 比我现象中的容易实现.</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
              <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                  <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltop</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : no {&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">()</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">goto_next_block</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exp error : not }&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="k">break</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
          
              <span class="k">return</span> <span class="n">v</span>
          </pre></div>
          </div>
          <div class="section" id="id6">
          <h1>函数</h1>
          <p>好了, 没有函数的语言是不完整的. 为了实现函数, 需要做很多工作.</p>
          <p>先看语法, l0上面加的是调用函数, function_args是函数调用的参数, exp里面加上函数定义的部分, function_args_names是形参.</p>
          <pre class="literal-block">
          l0 = (ltop) | n | NAME | - n | NAME ( function_args )
          
          exp = ltop | assignment | condition | loop | function
          
          function = def NAME(function-args-names){exp_list}
          function_args_names = function_args , NAME | NAME  | None
          function_args = function_args , exp | exp | None
          </pre>
          <p>根据我看SICP学来的经验, 函数可以采用环境来实现.
          所谓环境的概念, 就是函数本身是嵌套的, 每个函数内部就是一个环境, 保存有一些局部变量, 只在函数内部有效. 传给函数的参数就是在函数的环境里面做对应的赋值.</p>
          <p>比如: def f1(a, b) {...}; f1(1, 2) , f1的环境是env1, f2的环境是env2, 在调用f1的时候, 执行到f1内部时, Caculator的self.env是env1, env1.values含有a, b 2个变量, 值分别是调用f1(1, 2)时传进来的1和2.</p>
          <p>我们看Env类的定义. 现在我们删除掉Caculator的values, 让Env的 get_value()和set_value来获取和设置变量. Env是嵌套的, 因为函数调用的时候, 也可以访问上层赋值过的变量.</p>
          <div class="highlight"><pre><span class="k">class</span> <span class="nc">Env</span><span class="p">():</span>
              <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
          
              <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                  <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
          
                  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;cannot find value: </span><span class="si">%s</span><span class="s">, current_values: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
          
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
          
              <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
          </pre></div>
          <p>然后是函数赋值, 我把函数抽象成了一个类, 保存函数名, 开始位置, 以及缓存词列表, 因为caculator类是可以执行多次代码的. 最后我利用赋值的方式把函数保存下来.</p>
          <div class="highlight"><pre><span class="k">class</span> <span class="nc">Func</span><span class="p">():</span>
              <span class="k">pass</span>
          
          <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">func</span> <span class="o">=</span> <span class="n">Func</span><span class="p">()</span>
          
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">issymbol</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;function error name : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="n">func</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;function error not (&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="n">func</span><span class="o">.</span><span class="n">arg_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_args_names</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;function error not )&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;function error not {&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="n">func</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
              <span class="n">func</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span>
          
              <span class="bp">self</span><span class="o">.</span><span class="n">goto_next_block</span><span class="p">()</span>
          
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;function error not }&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
              <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
              <span class="k">return</span> <span class="mi">0</span>
          </pre></div>
          <p>然后是函数执行的部分了. l0里面根据语法识别到函数调用, 然后执行function_all,
          里面首先生成一个新的环境, 然后在新的环境里面, 把实际参数赋值给形参, 然后保存现在的ls, p, env, 然后执行函数体, 然后回复ls, p, env.
          function_args解析和返回实际参数列表, function_args_names解析和返回形参名称, 保存在Func.names里面, 都比较简单就不列出来了.</p>
          <div class="highlight"><pre><span class="k">def</span> <span class="nf">l0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
              <span class="o">...</span>
              <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">issymbol</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">):</span>
                  <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                  <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_args</span><span class="p">()</span>
          
                  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;l0 function call error&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
          
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_call</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
          
          <span class="k">def</span> <span class="nf">function_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
              <span class="n">env</span> <span class="o">=</span> <span class="n">Env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
                  <span class="n">env</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
          
              <span class="bp">self</span><span class="o">.</span><span class="n">push_p</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span>
          
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">()</span>
          
              <span class="k">return</span> <span class="n">v</span>
          
          <span class="k">def</span> <span class="nf">push_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">pre_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">pre_ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span>
          
          <span class="k">def</span> <span class="nf">pop_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;pop_p: no parent for env!&#39;</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">parent</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_p</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_ls</span>
          </pre></div>
          <p>写完后才知道, 真的... 不复杂!</p>
          </div>
          <div class="section" id="id7">
          <h1>函数可以返回</h1>
          <p>现在函数还是一直执行到结尾才返回, 我希望能够支持return语句, 原本考虑了半天, 不知道如何通过重重的函数调用, 返回到最上面, 后来经过 <a class="reference external" href="http://www.douban.com/people/learno/">岚临</a> 同学的提醒, 用抛出异常, 在上层捕捉的方式实现了, 加的代码只有4行!</p>
          <p>语法:</p>
          <pre class="literal-block">
          exp = ltop | assignment | condition | loop | function | return
          return_exp = return ltop
          </pre>
          <p>进到return_exp里面后, 会抛出ReturnException, 在function_call里面捕捉, 正好是当前调用函数的部分.</p>
          <div class="highlight"><pre><span class="k">class</span> <span class="nc">ReturnException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
              <span class="sd">&quot;&quot;&quot;for implement return expression&quot;&quot;&quot;</span>
              <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                  <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
          
          <span class="k">def</span> <span class="nf">function_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_list</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">pop_p</span><span class="p">()</span>
              <span class="k">except</span> <span class="n">ReturnException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
          
          <span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_next</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                  <span class="o">...</span>
                  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;return&#39;</span><span class="p">:</span>
                      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_exp</span><span class="p">()</span>
          
          <span class="k">def</span> <span class="nf">return_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
              <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">pop_p</span><span class="p">()</span>
              <span class="k">raise</span> <span class="n">ReturnException</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
          </pre></div>
          </div>
          <div class="section" id="id9">
          <h1>结论</h1>
          <p>我一开始没有想到能够写那么多的, 结果一个语法一个语法加下来就变成这样了... 虽然没有性能优化, 以及其他的错误处理什么的东西,
          能够写出一个简单的语言, 还是让我很有成就感的. 我不是一个很强的程序员, 也能写出一个简单的语言, 相信你也可以写一个来玩玩!</p>
          <p>下一步: 虚拟机+字节码+编译 方式的语言, 实现协程+原生同步!</p>
          </div>
          </div>
        </div>
        <div class='time-stamp'>
          <p>建立时间: 2011/07/25 19:53:00</p>
        </div>
        <div id='comments'>
          <div id='disqus_thread'>
            <script type="text/javascript">
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://halidasvps.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=halidasvps">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            <script type="text/javascript">
            var disqus_shortname = 'halidasvps';
            (function () {
            var s = document.createElement('script'); s.async = true;
            s.src = 'http://disqus.com/forums/halidasvps/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());
            </script>
          </div>
        </div>
      </div>
      <footer>
        <p>
          @2011 linjunhalida, all right reserved,
          source code <a href="https://github.com/halida/haliblog" target="_blank">here</a>.
        </p>
      </footer>
    </div>
    <div id='return-top-block'>
      <div id='return-top-inner'>
        <a id='return-top' onclick="javascript: $('html,body').animate({scrollTop: 0}, 400);">===></a>
      </div>
    </div>
    <script src="/javascripts/jquery.pjax.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.appear-1.1.1.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js" type="text/javascript"></script>
    <script src="/javascripts/vim.js" type="text/javascript"></script>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
    
      $(function() {
        init();
        return init_vim_key('#content');
      });
    
    }).call(this);
    
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-26509244-1']);
        _gaq.push(['_trackPageview', '_trackPageLoadTime']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      //]]>
    </script>
  </body>
</html>
