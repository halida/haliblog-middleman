<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>网络寻租</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="halida" />
    <link rel="alternate" type="application/rss+xml" title="网络寻租 - RSS" href="http://blog.linjunhalida.com/feed" />
    <link href="/stylesheets/pygments-default.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/site.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/jquery.js" type="text/javascript"></script>
  </head>
  <body class='color-4'>
    <div id='warper'>
      <nav>
        <div id='container'>
          <ul class='first-nav'>
            <li>
              <a href="/">网络寻租</a>
            </li>
            <li>
              <a href="/list.html">列表</a>
            </li>
            <li>
              <a href="/about.html">关于</a>
            </li>
          </ul>
          <ul class='secondary-nav'>
            <li>
              <a href="/feed.xml">feed</a>
            </li>
          </ul>
          <select id='color-select'>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </div>
      </nav>
      <div id='block-nav'></div>
      <div id='content'>
        <div class='article'>
          <g:plusone></g:plusone>
          <script type='text/javascript'>
            //<![CDATA[
              window.___gcfg = {lang: 'zh-CN'};
              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
            //]]>
          </script>
          <h1 class='article-title'>PyQt4的异步消息机制</h1>
          <div class="document">
          <p>因为工作需要，要在GUI的后台维护一个监控线程，该线程需要和主线程做通讯。为了完成这个需求，需要采用一种线程安全的消息机制。因为我采用PyQt4作为GUI的库，因此，直接使用PyQt4的消息机制成为我考虑的首选。</p>
          <p>在PyQt4里面，发出消息采用emit的方式。比如:</p>
          <div class="highlight"><pre><span class="c"># 新的pythonic的方式</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sbValue</span><span class="o">.</span><span class="n">setValue</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
          <span class="c"># 旧的</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sbValue</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;setValue(int)&quot;</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span>
          </pre></div>
          <p>但是放到多线程里面，会发生什么事情呢？</p>
          <p>先解释一下消息处理的原理。我们知道，GUI之所以能够处理消息，是因为GUI主线程在初始化完毕的时候，会运行一个ecec_()方法，在这个方法里面，线程不断地检查消息队列，看是否有新的消息发出来，如果有，就处理它。这就是我们说的：event loop。</p>
          <p>然后看文档。 <a class="reference external" href="http://doc.trolltech.com/4.1/threads.html#synchronizing-threads">Qt在多线程下的消息传递机制</a> :</p>
          <img alt="http://doc.trolltech.com/4.1/images/threadsandobjects.png" class="align-center" src="http://doc.trolltech.com/4.1/images/threadsandobjects.png" style="width: 600px;" />
          <p>里面一段话:</p>
          <p>Qt supports three types of signal-slot connections:
          * With direct connections, the slot gets called immediately when the signal is emitted. The slot is executed in the thread that emitted the signal (which is not necessarily the thread where the receiver object lives).
          * With queued connections, the slot is invoked when control returns to the event loop of the thread to which the object belongs. The slot is executed in the thread where the receiver object lives.
          * With auto connections (the default), the behavior is the same as with direct connections if the signal is emitted in the thread where the receiver lives; otherwise, the behavior is that of a queued connection.</p>
          <p>也就是说，有3种机制：
          * 采用直接调用的方式。类似于callback。 调用者线程直接去执行被调用的方法。
          * 队列方式。调用者线程把消息丢给消息队列，然后就不管它了。被调用者的线程在处理消息队列的时候，就会处理它。
          * 自动方式（默认）。如果调用者和被调用者是属于一个线程的，系统选择直接调用，不然就采用队列的方式。</p>
          <p>而机制的选择，可以在connect方法里面设置type:</p>
          <div class="highlight"><pre><span class="kt">bool</span> <span class="n">QObject</span><span class="o">::</span><span class="n">connect</span> <span class="p">(</span><span class="k">const</span> <span class="n">QObject</span> <span class="o">*</span> <span class="n">sender</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">signal</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">QObject</span> <span class="o">*</span> <span class="n">receiver</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">method</span><span class="p">,</span>
                                 <span class="n">Qt</span><span class="o">::</span><span class="n">ConnectionType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">::</span><span class="n">AutoConnection</span><span class="p">)</span>
          </pre></div>
          <p>那麽，我们可以开始做实验验证这样是否在PyQt4里面行得通了。</p>
          <p>测试代码1：测试在单线程下，修改type之后，emit消息是否会立刻执行下一行代码:</p>
          <div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
          <span class="c">#-*- coding:utf-8 -*-</span>
          <span class="sd">&quot;&quot;&quot;</span>
          <span class="sd">线程中发消息</span>
          <span class="sd">&quot;&quot;&quot;</span>
          <span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
          <span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
          
          <span class="kn">import</span> <span class="nn">threading</span>
          <span class="kn">import</span> <span class="nn">time</span>
          
          <span class="k">class</span> <span class="nc">Main</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
              <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">QDialog</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;&amp;amp;amp;amp;OK&quot;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
          
                  <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span><span class="p">:</span>
                      <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
          
                  <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;waitProcess()&quot;</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">waitProcess</span><span class="p">)</span><span class="c">#, Qt.QueuedConnection)</span>
          
              <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threadRun</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
          
              <span class="k">def</span> <span class="nf">threadRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;waitProcess()&quot;</span><span class="p">))</span>
                  <span class="k">print</span> <span class="s">&quot;sended..&quot;</span>
          
              <span class="k">def</span> <span class="nf">waitProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;hello！&quot;</span><span class="p">)</span>
          
          <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
              <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">([])</span>
              <span class="n">Main</span><span class="p">()</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
          
          <span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
              <span class="n">main</span><span class="p">()</span>
          </pre></div>
          <p>点击按钮，&quot;sended!&quot;要过一段时间才出现在命令行。
          把上面的注释部分改为:</p>
          <div class="highlight"><pre><span class="n">self</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;waitProcess()&quot;</span><span class="p">),</span>
                       <span class="n">self</span><span class="p">.</span><span class="n">waitProcess</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
          </pre></div>
          <p>再执行一次，点击按钮，&quot;sended!&quot;立刻就出现了。</p>
          <p>测试代码2：现在转到线程里面:</p>
          <div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
          <span class="c">#-*- coding:utf-8 -*-</span>
          <span class="sd">&quot;&quot;&quot;</span>
          <span class="sd">线程中发消息</span>
          <span class="sd">&quot;&quot;&quot;</span>
          <span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
          <span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
          
          <span class="kn">import</span> <span class="nn">threading</span>
          <span class="kn">import</span> <span class="nn">time</span>
          
          <span class="k">class</span> <span class="nc">Main</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
              <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">QDialog</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
          
                  <span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s">&quot;&amp;amp;OK&quot;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
          
                  <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span><span class="p">:</span>
                  <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
          
                  <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbProcess</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;waitProcess()&quot;</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">waitProcess</span><span class="p">)</span><span class="c">#, Qt.QueuedConnection)</span>
          
              <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threadRun</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
          
              <span class="k">def</span> <span class="nf">threadRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;waitProcess()&quot;</span><span class="p">))</span>
                  <span class="k">print</span> <span class="s">&quot;sended..&quot;</span>
          
              <span class="k">def</span> <span class="nf">waitProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">leResult</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;hello！&quot;</span><span class="p">)</span>
          
          <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
              <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">([])</span>
              <span class="n">Main</span><span class="p">()</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
              <span class="c">#app.exec_()</span>
          
          <span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
              <span class="n">main</span><span class="p">()</span>
          </pre></div>
          <p>执行后，前3秒线程等待，GUI不会卡死。然后线程打印：&quot;sended..&quot;，然后GUI卡死3秒，然后GUI显示&quot;hello!&quot;。</p>
          </div>
        </div>
        <div class='time-stamp'>
          <p>建立时间: 2010/10/29 20:37:00</p>
          <p>更新时间: 2010/11/25 13:35:00</p>
        </div>
        <div id='comments'>
          <div id='disqus_thread'>
            <script type="text/javascript">
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://halidasvps.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=halidasvps">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
            <script type="text/javascript">
            var disqus_shortname = 'halidasvps';
            (function () {
            var s = document.createElement('script'); s.async = true;
            s.src = 'http://disqus.com/forums/halidasvps/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());
            </script>
          </div>
        </div>
      </div>
      <footer>
        <p>
          @2011 linjunhalida, all right reserved,
          source code <a href="https://github.com/halida/haliblog" target="_blank">here</a>.
        </p>
      </footer>
    </div>
    <div id='return-top-block'>
      <div id='return-top-inner'>
        <a id='return-top' onclick="javascript: $('html,body').animate({scrollTop: 0}, 400);">===></a>
      </div>
    </div>
    <script src="/javascripts/jquery.pjax.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.appear-1.1.1.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js" type="text/javascript"></script>
    <script src="/javascripts/vim.js" type="text/javascript"></script>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
    
      $(function() {
        init();
        return init_vim_key('#content');
      });
    
    }).call(this);
    
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-26509244-1']);
        _gaq.push(['_trackPageview', '_trackPageLoadTime']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      //]]>
    </script>
  </body>
</html>
